include ../VERSION

CXX           = @CXX@
CXXFLAGS      = @CXXFLAGS@ @MPI_FLAGS@ -DPEBIL_VER="\"$(PEBIL_FULL_VER)\"" -w
SHARED_OPT    = -fPIC
SHARED_LIB    = -shared
EXTRA_FLAGS   = $(SHARED_OPT)

SRCDIR        = ../src
BINDIR        = ../bin
LIBDIR        = ../lib
EXTDIR        = ../external
EXTRA_INC     = -I. -I../include -I$(EXTDIR)/udis86-1.7/ -I../instcode
EXTRA_LIBS    = -L$(SRCDIR) -lpebilinst -L$(EXTDIR)/udis86-1.7/libudis86/.libs -ludis86 -ldl

TARGETS  = pebil
TOOLS = BasicBlockCounter CacheSimulation CallReplace Classification FunctionCounter FunctionTimer RareEventCounter ThrottleLoop
SRCS = $(foreach var,$(TOOLS),$(var).C)
OBJS = $(foreach var,$(TOOLS),$(var).o)
LIBS = $(foreach var,$(TOOLS),lib$(var)Tool.so)

all: $(LIBS) $(TARGETS)

pebil :	pebil.o
	$(CXX) $(CXXFLAGS) -o $@ pebil.o $(EXTRA_INC) $(EXTRA_LIBS)

%.o: %.C
	$(CXX) $(CXXFLAGS) $(EXTRA_FLAGS) $(EXTRA_INC) -c -o $@ $<

lib%Tool.so: %.o
	$(CXX) $(SHARED_LIB) -o $@ $<

clean: 
	rm -f *inst *.static core *.o *.ii *.s *.so $(TARGETS)

depend:
	g++ -E -MM $(EXTRA_INC) $(SRCS) pebil.C > DEPENDS

install: $(TARGETS) $(LIBS)
	cp $(TARGETS) $(BINDIR)
	cp $(LIBS) $(LIBDIR)

include DEPENDS
